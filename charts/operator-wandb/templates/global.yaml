apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-global-configmap
  labels:
    {{- include "wandb.commonLabels" . | nindent 4 }}
  annotations:
    "reflector.v1.k8s.emberstack.com/reflection-allowed": "true"
    "reflector.v1.k8s.emberstack.com/reflection-auto-enabled": "true"
    "reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces": "{{ .Release.Name }}-.*"
data:
  # Statsd configuration (matches existing GORILLA_STATSD_PORT from gorilla.yaml)
  {{- if and .Values.global .Values.global.observability }}
    {{- if eq (default "custom" .Values.global.observability.mode) "otel" }}
  GORILLA_STATSD_HOST: "0.0.0.0"
  GORILLA_STATSD_PORT: "8125"
    {{- end }}
  {{- else }}
  GORILLA_STATSD_HOST: ""
  GORILLA_STATSD_PORT: "0"
  {{- end }}
  {{- if dig "global" "datadog" "dogstatsd" "uds" "enabled" false .Values.AsMap }}
  {{- $socketPath := dig "global" "datadog" "dogstatsd" "uds" "socketPath" "/var/run/datadog/dsd.socket" .Values.AsMap -}}
  GORILLA_STATSD_ADDRESS: {{ printf "unixgram://%s" $socketPath | quote }}
  {{- end }}

  GORILLA_LICENSE_CERT_PATH: {{ .Values.global.licenseCertPath }}
  # T-shirt size for deployment
  GORILLA_TSHIRT_SIZE: {{ .Values.global.size | default "small" | quote }}
  GORILLA_ONPREM: "true"

  ONPREM: "true"

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-global-secret
  labels:
    {{- include "wandb.commonLabels" . | nindent 4 }}
  annotations:
    "reflector.v1.k8s.emberstack.com/reflection-allowed": "true"
    "reflector.v1.k8s.emberstack.com/reflection-auto-enabled": "true"
    "reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces": "{{ .Release.Name }}-.*"
data:
  GORILLA_STATSIG_KEY: {{ default "" .Values.global.statsig.apiKey | b64enc }}
  GORILLA_EMAIL_SINK: {{ include "wandb.emailSink" . | b64enc }}
  GORILLA_SLACK_CLIENT_ID: {{ default "" .Values.global.slack.clientId | b64enc }}
  GORILLA_SLACK_SECRET: {{ default "" .Values.global.slack.secret | b64enc }}

  SLACK_CLIENT_ID: {{ default "" .Values.global.slack.clientId | b64enc }}
  SLACK_SECRET: {{ default "" .Values.global.slack.secret | b64enc }}
