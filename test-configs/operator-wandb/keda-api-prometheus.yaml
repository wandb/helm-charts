# Example: Using KEDA to auto-scale the API service based on Prometheus metrics
# The API scales based on custom application metrics like request rate or queue depth.

api:
  install: true
  size: "production"
  sizing:
    production:
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      autoscaling:
        # Disable standard HPA in favor of KEDA
        horizontal:
          enabled: false
        # Enable KEDA for metric-driven autoscaling
        keda:
          enabled: true
          minReplicaCount: 3 # Minimum for high availability
          maxReplicaCount: 30 # Scale up to 30 replicas under high load
          pollingInterval: 30 # Check Prometheus every 30 seconds
          fallback:
            failureThreshold: 3 # Allow 3 failed checks before fallback
            replicas: 10 # Fallback to 10 replicas if metrics unavailable
          advanced:
            # Custom HPA scaling behavior
            horizontalPodAutoscalerConfig:
              behavior:
                scaleDown:
                  stabilizationWindowSeconds: 300 # Wait 5 min before scaling down
                  policies:
                    - type: Percent
                      value: 50
                      periodSeconds: 60
                scaleUp:
                  stabilizationWindowSeconds: 0 # Scale up immediately
                  policies:
                    - type: Percent
                      value: 100
                      periodSeconds: 30
                    - type: Pods
                      value: 5
                      periodSeconds: 30
                  selectPolicy: Max
          triggers:
            # Scale based on HTTP request rate
            - type: prometheus
              metadata:
                serverAddress: http://prometheus:9090
                metricName: api_request_rate
                threshold: "100" # 100 requests per second per replica
                query: |
                  sum(rate(http_requests_total{job="wandb-api"}[2m]))
            # Also consider active connections
            - type: prometheus
              metadata:
                serverAddress: http://prometheus:9090
                metricName: api_active_connections
                threshold: "500" # 500 active connections per replica
                query: |
                  sum(http_active_connections{job="wandb-api"})
