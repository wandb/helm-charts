# Example: Using KEDA to auto-scale flat-run-fields-updater based on Kafka lag
#
# With KEDA defaults now in the sizing presets, users only need to:
# 1. Enable KEDA (keda.enabled: true)
# 2. Disable HPA (horizontal.enabled: false)
# 3. Provide triggers
# 4. Optionally override minReplicaCount for dev (0 vs production default)
#
# The sizing preset provides: pollingInterval, cooldownPeriod, fallback,
# advanced HPA behavior, and production-safe min/max replica counts.

flat-run-fields-updater:
  install: true
  size: "large"
  sizing:
    large:
      autoscaling:
        horizontal:
          enabled: false
        keda:
          enabled: true
          # Override minReplicaCount for dev (sizing default is 6 for large)
          minReplicaCount: 0
          # Override maxReplicaCount for dev (sizing default is 15 for large)
          maxReplicaCount: 3
          triggers:
            - type: kafka
              metadata:
                bootstrapServers: bufstream.bufstream.svc.cluster.local:9092
                consumerGroup: flat-run-fields-updater
                topic: wandb-run-updates-shadow
                lagThreshold: "10"
                limitToPartitionsWithLag: "true"
            # Optional: Add CPU/memory triggers for hybrid scaling
            - type: cpu
              metricType: Utilization
              metadata:
                value: "80"
            - type: memory
              metricType: Utilization
              metadata:
                value: "80"
